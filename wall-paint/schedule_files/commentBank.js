(function($){$.fn.insertAtCaret=function(myValue){var x=0;return this.each(function(){var id=$(this).attr("id");if(id===undefined){id="tempId-"+x++;$(this).attr("id",tempId)}else id=$(this).attr("id");edInsertContent(id,myValue)})}})(jQuery);
(function($){var self=null;var config={leftArrow:"images/left-arrow-small.gif",rightArrow:"images/right-arrow-small.gif",loadingText:null,openCommentBankText:null,closeCommentBankText:null,codesNotFoundText:null,selectedClassName:"menuItemHighlight"};function getCommentBankCloseText(){if(config.closeCommentBankText==null)config.closeCommentBankText=grabResource("label.commentBank.close");return config.closeCommentBankText}function getCommentBankCodesNotFoundText(){if(config.codesNotFoundText==null)config.codesNotFoundText=
grabResource("label.commentBank.codesNotFound");return config.codesNotFoundText}function getCommentBankLoadingText(){if(config.loadingText==null)config.loadingText=grabResource("label.loading");return config.loadingText}function getCommentBankOpenText(){if(config.openCommentBankText==null)config.openCommentBankText=grabResource("label.commentBank.open");return config.openCommentBankText}$.fn.commentBank=function(){return this.each(function(){new $.commentBank(this)})};$.commentBank=function(e){this.commentBankText=
$(e);this.commentBankText.parents("td").eq(0).removeAttr("nowrap");this.cbtOid=this.commentBankText.attr("data-cbtOid");this.beanOid=this.commentBankText.attr("data-beanOid");if(!this.cbtOid)return;else this.init()};$.commentBank.prototype={init:function(){this.tagName=this.commentBankText.get(0).tagName;this.collapsed=true;this.loadedCodes=false;this.createElements()},createElements:function(){var self=this;this.commentBankWrapper=$("<div class='comment-bank'>");this.commentBankText.wrap(this.commentBankWrapper);
this.commentBankText.keydown(function(event){if(event.keyCode===9)self.toggleOptions();else if(event.keyCode==27)self.collapseOptions()});this.commentBankSlider=$("<div class='comment-bank-slider templateCellShaded'>");this.commentBankText.after(this.commentBankSlider);var commentBankDiv=$("<div class='comment-bank-nub'>");this.commentBankNub=$("<img src='"+config.leftArrow+"'>");this.commentBankNub.attr({"title":getCommentBankOpenText()});commentBankDiv.append(this.commentBankNub);this.commentBankSlider.append(commentBankDiv);
this.commentBankOptions=$("<div class='comment-bank-options'>");this.commentBankOptions.height(this.commentBankText.height()-commentBankDiv.height());this.commentBankSlider.append(this.commentBankOptions);this.commentBankNub.bind("click",function(){self.toggleOptions()})},getTable:function(){var self=this;function showBox1(){var category1=self.commentCategory1Box.val();if(!category1)return;self.getCodes({"cbtCategory1":category1});var categories2=self.categories[category1];self.commentCategory3Div.hide();
if(categories2){self.commentCategory2Div.show();self.commentCategory2Box.empty().append($("<option>").val("").text("All"));if(categories2)$.each(categories2,function(category){self.commentCategory2Box.append($("<option>").val(category).text(category))})}else self.commentCategory2Div.hide()}var loadingText=$("<p class='comment-bank-loading'>").text(getCommentBankLoadingText);self.commentBankOptions.html(loadingText);self.commentBankCategories=$("<div>").addClass("comment-bank-categories");self.commentCategory1Div=
$("<div>").addClass("comment-bank-category");self.commentCategory2Div=$("<div>").addClass("comment-bank-category").hide();self.commentCategory3Div=$("<div>").addClass("comment-bank-category").hide();self.commentCategory1Box=$("<select>").attr({"name":"category1","id":"cbtCategory1"}).append($("<option>"));self.commentCategory2Box=$("<select>").attr({"name":"category2","id":"cbtCategory2"}).append($("<option>").val("").text("All"));self.commentCategory3Box=$("<select>").attr({"name":"category3","id":"cbtCategory3"}).append($("<option>").val("").text("All"));
doPost("commentBankAjax.do",{"action":"getTable","cbtOid":this.cbtOid},function(data){self.categories=data.categories;if(data.codesCount>0){if(!data.cbtCategory1)self.getCodes({});$.each(self.categories,function(category1){self.commentCategory1Box.append($("<option>").val(category1).text(category1))});if(data.cbtCategory1){self.commentCategory1Div.append($("<label>").attr({"for":"cbtCategory1"}).text(data.cbtCategory1));self.commentBankCategories.append(self.commentCategory1Div)}if(data.cbtCategory2){self.commentCategory2Div.append($("<label>").attr({"for":"cbtCategory2"}).text(data.cbtCategory2));
self.commentBankCategories.append(self.commentCategory2Div)}if(data.cbtCategory3){self.commentCategory3Div.append($("<label>").attr({"for":"cbtCategory3"}).text(data.cbtCategory3));self.commentBankCategories.append(self.commentCategory3Div)}self.commentBankOptions.append(self.commentBankCategories);self.commentCategory1Div.append(self.commentCategory1Box);var checkbox=$("<input>");checkbox.attr("type","checkbox");checkbox.addClass("comment-bank-checkbox");checkbox.bind("change",function(e){if(self.showMyCodes)self.showMyCodes=
false;else self.showMyCodes=true;showBox1()});self.commentCategory1Div.append(checkbox);self.commentCategory1Div.append($("<label>").text(grabResource("label.showMyCodes")));self.commentCategory2Div.append(self.commentCategory2Box);self.commentCategory3Div.append(self.commentCategory3Box);self.commentBankSearchBox=$("<input>").attr({"type":"text","class":"comment-bank-searchBox","autocomplete":"off","placeholder":"Search"});self.commentBankOptions.append(self.commentBankSearchBox);self.setupSearchBoxEvents();
if(data.codesCount>0)loadingText.remove()}else loadingText.text(getCommentBankCodesNotFoundText())});self.commentCategory1Box.bind("change",showBox1);self.commentCategory2Box.bind("change",function(e){var category1=self.commentCategory1Box.val();var category2=self.commentCategory2Box.val();if(category2)self.getCodes({"cbtCategory1":category1,"cbtCategory2":category2});else self.getCodes({"cbtCategory1":category1});var categories3=self.categories[category1][category2];if(categories3){self.commentCategory3Div.show();
self.commentCategory3Box.empty().append($("<option>").val("").text("All"));for(i in categories3)self.commentCategory3Box.append($("<option>").val(categories3[i]).text(categories3[i]))}else self.commentCategory3Div.hide()});self.commentCategory3Box.bind("change",function(e){var category1=self.commentCategory1Box.val();var category2=self.commentCategory2Box.val();var category3=self.commentCategory3Box.val();if(category3)self.getCodes({"cbtCategory1":category1,"cbtCategory2":category2,"cbtCategory3":category3});
else self.getCodes({"cbtCategory1":category1,"cbtCategory2":category2})})},getCodes:function(params){var self=this;var defaults={"action":"getCodes","cbtOid":this.cbtOid,"beanOid":this.beanOid};doPost("commentBankAjax.do",$.extend({},defaults,params),function(data){self.setupCache(data);self.generateOptions(data);self.comments=self.commentBankOptions.children(".comment-bank-option");self.comments.click(function(){self.insertCode($(this))})})},setupSearchBoxEvents:function(){var self=this;this.commentBankSearchBox.keyup(function(event){if(!self.comments)return;
if(event.keyCode==27){self.collapseOptions();self.commentBankText.focus()}else if(event.keyCode==13){var option=self.currentVisibleOptions.eq(self.currentSelectedIndex);if(self.currentSelectedIndex!==-1)self.insertCode(option)}else if(event.keyCode==40){if(self.currentSelectedIndex!==self.currentVisibleMaxIndex){self.currentVisibleOptions.eq(self.currentSelectedIndex++).removeClass(config.selectedClassName);self.currentVisibleOptions.eq(self.currentSelectedIndex).addClass(config.selectedClassName)}}else if(event.keyCode==
38){if(self.currentSelectedIndex!==0){self.currentVisibleOptions.eq(self.currentSelectedIndex--).removeClass(config.selectedClassName);self.currentVisibleOptions.eq(self.currentSelectedIndex).addClass(config.selectedClassName)}}else{var term=this.value.toLowerCase();if(!term){self.comments.removeClass(config.selectedClassName).show();self.comments.first().addClass(config.selectedClassName);self.currentVisibleOptions=self.comments;self.currentSelectedIndex=self.currentVisibleOptions.index($(".menuItemHighlight"));
self.currentVisibleMaxIndex=self.currentVisibleOptions.length-1}else{self.comments.removeClass(config.selectedClassName).hide();$.each(self.comments,function(i){if($(this).text().toLowerCase().indexOf(term)!=-1||$(this).data("cbcid").toString().toLowerCase().indexOf(term)!=-1)self.comments.eq(i).show()});self.currentVisibleOptions=$(".comment-bank-option:visible");self.currentVisibleMaxIndex=self.currentVisibleOptions.length-1;self.currentVisibleOptions.first().addClass(config.selectedClassName);
self.currentSelectedIndex=self.currentVisibleOptions.index($(".menuItemHighlight"))}}})},generateOptions:function(jsonData){var self=this;$(".comment-bank-option").remove();var codes=jsonData.codes;if(self.showMyCodes)codes=jsonData.myCodes;$.each(codes,function(i,code){var $option=$("<div>");$option.addClass("comment-bank-option");$option.attr({"data-cbcOid":code.cbcOid});$option.attr({"data-cbcId":code.cbcId});var $preview=$("<span>").addClass("preview").html(code.cbcPreview);$option.append($preview);
var cbtCategory1=jsonData.cbtCategory1;if(code.cbcCategory1)$option.append($("<span>").addClass("category").html(code.cbcCategory1));var cbtCategory2=jsonData.cbtCategory2;if(code.cbcCategory2)$option.append($("<span>").addClass("category").html(code.cbcCategory2));var cbtCategory3=jsonData.cbtCategory3;if(code.cbcCategory3)$option.append($("<span>").addClass("category").html(code.cbcCategory3));self.commentBankOptions.append($option)})},setupCache:function(jsonData){this.cache=$.map(jsonData.codes,
function(code){return code.cbcOid})},insertCode:function($option){var self=this;var preview=$option.html();var cbcOid=$option.attr("data-cbcOid");$option.html(getCommentBankLoadingText);var params={"action":"parse","beanOid":this.beanOid,"cbcOid":cbcOid};doPost("commentBankAjax.do",params,function(data){if(self.tagName=="IFRAME")self.commentBankText.get(0).contentWindow.document.body.innerHTML+=data.results+"&nbsp;";else{self.commentBankText.insertAtCaret(data.results+" ");self.commentBankText.focus()}$option.html(preview)})},
expandOptions:function(){var self=this;if(!this.loadedCodes){self.getTable();this.loadedCodes=true}if(self.collapsed){self.commentBankNub.attr({"src":config.rightArrow,"title":getCommentBankCloseText()});self.collapsed=false;self.commentBankOptions.css({"display":"block"})}},collapseOptions:function(){var self=this;if(!self.collapsed){self.commentBankNub.attr({"src":config.leftArrow,"title":getCommentBankOpenText()});self.collapsed=true;self.commentBankOptions.css({"display":"none"})}},toggleCodes:function(){var self=
this;if(self.showMyCodes)self.showMyCodes=false;else self.showMyCodes=true},toggleOptions:function(){var self=this;if(self.collapsed)self.expandOptions();else self.collapseOptions()}}})(jQuery);