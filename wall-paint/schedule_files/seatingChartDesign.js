(function(Aspen,$){var SeatingChartDesign={};var maxDesignCells=250;var chartData=new Array;var unseatedStudents=new Array;var chartOid=null;SeatingChartDesign.addSeatedStudent=function(position,chartStudent){chartData[position]=chartStudent};SeatingChartDesign.addUnseatedStudent=function(chartStudent){unseatedStudents[unseatedStudents.length]=chartStudent};var cellBlur=function(cell){stripMouseoverClasses(cell);cell.className+=" designCellMouseout"};var cellFocus=function(cell){stripMouseoverClasses(cell);
cell.className+=" designCellMouseover"};SeatingChartDesign.drawChart=function(){var designGrid=document.getElementById("designGrid");designGrid.onselectstart=new Function("return false");designGrid.onmousedown=disabletext;designGrid.onclick=reEnable;var chartWidthElement=document.forms[0].elements["width"];var chartHeightElement=document.forms[0].elements["height"];var chartWidth=chartWidthElement.value;var chartHeight=chartHeightElement.value;var validSize=true;if(chartWidth*chartHeight>maxDesignCells){alert(grabResource("error.seatingChart.exceededMaxSize"));
validSize=false}else for(var pos in chartData){var parsedCoords=pos.split("|");if(parseInt(parsedCoords[0])>=parseInt(chartWidth)||parseInt(parsedCoords[1])>=parseInt(chartHeight)){alert(grabResource("error.seatingChart.reduction"));validSize=false;break}}if(!validSize){chartWidthElement.value=chartWidthElement.defaultValue;chartHeightElement.value=chartHeightElement.defaultValue}else{chartWidthElement.defaultValue=chartWidthElement.value;chartHeightElement.defaultValue=chartHeightElement.value;var rowCount=
designGrid.rows.length;for(var i=rowCount-1;i>=0;i--)designGrid.deleteRow(i);for(var y=0;y<chartHeight;y++){var row=designGrid.insertRow(y);for(var x=0;x<chartWidth;x++){var cell=row.insertCell(x);cell.className="designCell";cell.align="center";if(y==0)cell.className+=" designTopCell";if(x==0)cell.className+=" designLeftCell";cell.innerHTML="<img src='images/spacer.gif' width='50'>";cell.id=x+"|"+y;cell.onmouseover=function(ev){if(dragObject==null)cellFocus(this)};cell.onmouseout=function(ev){cellBlur(this)};
addDropTarget(cell)}}for(var pos in chartData){var cell=document.getElementById(pos);SeatingChartDesign._seatStudent(chartData[pos],cell,true,true)}}};SeatingChartDesign._alertUserStudentsAlreadySeated=function(msg){alert(msg)};SeatingChartDesign._studentsAlreadySeated=function(chartDataTable,msg){if(!_.isEmpty(_.keysIn(chartDataTable))){SeatingChartDesign._alertUserStudentsAlreadySeated(msg);return true}else return false};var getDropCellfromXY=function(currentX,currentY){var dropCellId=currentX+
"|"+currentY;return document.getElementById(dropCellId)};SeatingChartDesign._seatAllStudents=function(chartDataArray,unseatedStudentsArray,chartWidth,chartHeight){for(var currentX=0;currentX<chartWidth;currentX++)for(var currentY=0;currentY<chartHeight&&unseatedStudentsArray.length>0;currentY++){var dropCell=getDropCellfromXY(currentX,currentY);var student=unseatedStudentsArray.shift();SeatingChartDesign._seatStudent(student,dropCell,false,false)}};SeatingChartDesign.seatUnseatedStudentsAlphabetically=
function(){if(!SeatingChartDesign._studentsAlreadySeated(chartData,"Please use the Reset button to reset the seating chart before attempting to place students alphabetically.")){var chartWidthElement=document.forms[0].elements["width"].value;var chartHeightElement=document.forms[0].elements["height"].value;SeatingChartDesign._seatAllStudents(chartData,unseatedStudents,chartWidthElement,chartHeightElement)}};SeatingChartDesign.seatUnseatedStudentsRandomly=function(){if(!SeatingChartDesign._studentsAlreadySeated(chartData,
"Please use the Reset button to reset the seating chart before attempting to place students randomly.")){var chartWidthElement=document.forms[0].elements["width"].value;var chartHeightElement=document.forms[0].elements["height"].value;var randomizedStudents=_.shuffle(unseatedStudents);SeatingChartDesign._seatAllStudents(chartData,randomizedStudents,chartWidthElement,chartHeightElement)}};SeatingChartDesign.drawUnseatedStudents=function(){var unseatedTable=document.getElementById("unseatedStudents");
unseatedTable.onselectstart=new Function("return false");unseatedTable.onmousedown=disabletext;unseatedTable.onclick=reEnable;var i;var rowCount=unseatedTable.rows.length;for(i=rowCount-1;i>=0;i--)unseatedTable.deleteRow(i);unseatedStudents.sort(sortUnseatedStudents);for(i=0;i<unseatedStudents.length;i++){var chartStudent=unseatedStudents[i];var row=unseatedTable.insertRow(i);row.style.height="10px";var cell=row.insertCell(0);cell.className="unseatedStudentCell";var studentDiv=document.createElement("div");
studentDiv.innerHTML=chartStudent.name;studentDiv.id=chartStudent.toString();studentDiv.className="unseatedStudentDiv";cell.appendChild(studentDiv);makeDraggable(studentDiv);var gutterCell=row.insertCell(1);gutterCell.className="unseatedStudentCell";gutterCell.innerHTML="<img src='images/spacer.gif' height='28' width='1'>";gutterCell.width=1}while(i<16){var row=unseatedTable.insertRow(i);var cell=row.insertCell(0);cell.className="unseatedStudentCell";cell.innerHTML="&nbsp;";cell.colSpan=2;i++}};SeatingChartDesign.initialize=
function(seatingChartOid){chartOid=seatingChartOid;$(document).ready(function(){$(document).on("mousemove",mouseMove);$(document).on("mouseup",mouseUp)})};var isPositionEmpty=function(position){return chartData[position]==null};var isStudentSeated=function(chartStudent){var isSeated=true;for(var i=0;i<unseatedStudents.length;i++)if(chartStudent.studentOid==unseatedStudents[i].studentOid){isSeated=false;break}return isSeated};var locateStudent=function(chartStudent){var studentPos=null;for(var pos in chartData)if(chartData[pos]!=
null&&chartData[pos].toString()==chartStudent.toString()){studentPos=pos;break}return studentPos};var removeUnseatedStudent=function(chartStudent){var positionToRemove=-1;for(var i=0;i<unseatedStudents.length;i++)if(chartStudent.studentOid==unseatedStudents[i].studentOid){positionToRemove=i;break}if(positionToRemove>-1)unseatedStudents.splice(positionToRemove,1)};SeatingChartDesign._seatStudent=function(chartStudent,dropCell,bypassSave,bypassValidation){if(bypassValidation||isPositionEmpty(dropCell.id)){unseatStudent(chartStudent,
true);var studentDiv=document.createElement("div");studentDiv.innerHTML=chartStudent.name;studentDiv.id=chartStudent.toString();studentDiv.className="seatedStudentDiv";makeDraggable(studentDiv);dropCell.innerHTML="";dropCell.appendChild(studentDiv);if(dragObject!=null)dragObject.style.display="none";removeUnseatedStudent(chartStudent);SeatingChartDesign.drawUnseatedStudents();SeatingChartDesign.addSeatedStudent(dropCell.id,chartStudent);if(!bypassSave)ajaxSeatStudent(dropCell.id,chartStudent)}else{var originalPos=
locateStudent(chartStudent);if(dropCell.id!=originalPos)alert(grabResource("error.seatingChart.positionOccupied"));var originalCell=document.getElementById(originalPos);unseatStudent(chartStudent,true);if(originalCell!=null)SeatingChartDesign._seatStudent(chartStudent,originalCell,true,false);else SeatingChartDesign.drawUnseatedStudents()}};var sortUnseatedStudents=function(chartStudent1,chartStudent2){var sortResult=0;if(chartStudent1.name>chartStudent2.name)sortResult=1;else if(chartStudent1.name<
chartStudent2.name)sortResult=-1;return sortResult};var stripMouseoverClasses=function(cell){cell.className=cell.className.replace(/\sdesignCellMouseover/g,"");cell.className=cell.className.replace(/\sdesignCellMouseout/g,"")};SeatingChartDesign.trimChart=function(){var width=document.forms[0].elements["width"].value;var height=document.forms[0].elements["height"].value;var firstX=9999;var firstY=9999;var lastX=0;var lastY=0;var chartDataCopy=new Array;for(var pos in chartData){var parsedCoords=pos.split("|");
var x=parseInt(parsedCoords[0]);var y=parseInt(parsedCoords[1]);if(x<firstX)firstX=x;if(x>lastX)lastX=x;if(y<firstY)firstY=y;if(y>lastY)lastY=y;chartDataCopy[pos]=chartData[pos]}if(firstX!=9999){chartData=new Array;for(var pos in chartDataCopy){var chartStudent=chartDataCopy[pos];var parsedCoords=pos.split("|");var x=parseInt(parsedCoords[0]);var y=parseInt(parsedCoords[1]);var newX=x-firstX;var newY=y-firstY;var newCoords=newX+"|"+newY;chartData[newCoords]=chartStudent;ajaxSeatStudent(newCoords,
chartStudent)}document.forms[0].elements["width"].value=lastX-firstX+1;document.forms[0].elements["height"].value=lastY-firstY+1;SeatingChartDesign.drawChart();SeatingChartDesign.ajaxResizeChart()}else alert(grabResource("error.seatingChart.trimEmpty"))};SeatingChartDesign.reloadPageHelper=function(){window.location.reload()};SeatingChartDesign.resetSeats=function(){var url="seatingChartEdit.do?function=clear&chartOid="+chartOid;makeAsynchronousXmlRequest(url,"Aspen.SeatingChartDesign.reloadPageHelper",
"Aspen.SeatingChartDesign.ajaxResultError()")};SeatingChartDesign.removeWithdrawnStudents=function(){var url="seatingChartEdit.do?function=removeWithdrawnStudents&chartOid="+chartOid;makeAsynchronousXmlRequest(url,"Aspen.SeatingChartDesign.reloadPageHelper","Aspen.SeatingChartDesign.ajaxResultError()")};var unseatStudent=function(chartStudent,bypassSave){for(var pos in chartData)if(chartData[pos]!=null&&chartData[pos].studentOid==chartStudent.studentOid){var sourceCell=document.getElementById(pos);
sourceCell.innerHTML="<img src='images/spacer.gif' width='50'>";stripMouseoverClasses(sourceCell);delete chartData[pos]}if(!bypassSave)ajaxUnseatStudent(chartStudent)};var waitMessage=function(){return grabResource("message.wait")};var ajaxSeatStudent=function(cellId,chartStudent){var parsedString=cellId.split("|");var x=parsedString[0];var y=parsedString[1];var url="seatingChartEdit.do?function=seat&chartOid="+chartOid+"&studentOid="+chartStudent.studentOid+"&x="+x+"&y="+y;makeAsynchronousXmlRequest(url,
"Aspen.SeatingChartDesign.ajaxResultSuccess","Aspen.SeatingChartDesign.ajaxResultError()");var td=document.getElementById("messageArea");td.innerHTML=waitMessage();td.style.color="blue";td.style.fontSize="10pt";td.style.fontWeight="bold"};var ajaxUnseatStudent=function(chartStudent){var url="seatingChartEdit.do?function=unseat&chartOid="+chartOid+"&studentOid="+chartStudent.studentOid;makeAsynchronousXmlRequest(url,"Aspen.SeatingChartDesign.ajaxResultSuccess","Aspen.SeatingChartDesign.ajaxResultError()");
var td=document.getElementById("messageArea");td.innerHTML=waitMessage();td.style.color="blue";td.style.fontSize="10pt";td.style.fontWeight="bold"};SeatingChartDesign.ajaxResizeChart=function(){var chartWidth=document.forms[0].elements["width"].value;var chartHeight=document.forms[0].elements["height"].value;var url="seatingChartEdit.do?function=resize&chartOid="+chartOid+"&width="+chartWidth+"&height="+chartHeight;makeAsynchronousXmlRequest(url,"Aspen.SeatingChartDesign.ajaxResultSuccess","Aspen.SeatingChartDesign.ajaxResultError()");
var td=document.getElementById("messageArea");td.innerHTML=waitMessage();td.style.color="blue";td.style.fontSize="10pt";td.style.fontWeight="bold"};SeatingChartDesign.ajaxResultError=function(){alert("Communication error")};SeatingChartDesign.ajaxResultSuccess=function(){var td=document.getElementById("messageArea");td.innerHTML="&nbsp;"};var mouseMove=function(ev){ev=ev||window.event;var mousePos=mouseCoords(ev);if(dragObject){dragObject.style.position="absolute";dragObject.style.top=mousePos.y-
mouseOffset.y;dragObject.style.left=mousePos.x-mouseOffset.x;var targetFound=false;for(var i=0;i<dropTargets.length;i++){var curTarget=dropTargets[i];var targPos=getPosition(curTarget);var targWidth=parseInt(curTarget.offsetWidth);var targHeight=parseInt(curTarget.offsetHeight);if(mousePos.x>=targPos.x&&mousePos.x<=targPos.x+targWidth&&mousePos.y>=targPos.y&&mousePos.y<=targPos.y+targHeight){if(currentDropCell!=null)cellBlur(currentDropCell);currentDropCell=curTarget;cellFocus(currentDropCell);targetFound=
true}}if(!targetFound&&currentDropCell!=null){cellBlur(currentDropCell);currentDropCell=null}return false}};var mouseUp=function(){if(dragObject!=null){var chartStudent=createChartStudent(dragObject.id);if(currentDropCell!=null)SeatingChartDesign._seatStudent(chartStudent,currentDropCell);else{if(isStudentSeated(chartStudent)){unseatStudent(chartStudent);dragObject.style.display="none"}else removeUnseatedStudent(chartStudent);SeatingChartDesign.addUnseatedStudent(chartStudent);SeatingChartDesign.drawUnseatedStudents()}dragObject=
null}};SeatingChartDesign.ChartStudent=function(studentOid,name){this.studentOid=studentOid;this.name=name;this.toString=function(){return this.studentOid+"|"+this.name}};var createChartStudent=function(chartStudentString){var parsedString=chartStudentString.split("|");return new SeatingChartDesign.ChartStudent(parsedString[0],parsedString[1])};Aspen.SeatingChartDesign=SeatingChartDesign})(Aspen,jQuery);